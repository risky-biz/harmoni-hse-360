import{j as e,U as A,a0 as C,a3 as E,a4 as _}from"./index-CEPkdG4-.js";import{u as I,r as n}from"./react-vendor-CTgry22P.js";import{I as l}from"./Icon-B4fkNQKE.js";import{x as q,y as F,A as P,B as H,b as h,D as U,v as N,r as T,u as z}from"./coreui-vendor-BHlqdV6q.js";import"./redux-vendor-CopoOshl.js";const $=()=>{const x=I(),c=n.useRef(null),p=n.useRef(null),[d,j]=n.useState(!1),[g,i]=n.useState(null),[f,b]=n.useState(null),[o,y]=n.useState(null),[m,u]=n.useState(null);n.useEffect(()=>()=>{o&&o.getTracks().forEach(t=>t.stop())},[o]);const R=async()=>{try{i(null),j(!0);const t=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment",width:{ideal:1280},height:{ideal:720}}});y(t),c.current&&(c.current.srcObject=t,c.current.play(),c.current.onloadedmetadata=()=>{S()})}catch(t){i("Failed to access camera. Please ensure you have granted camera permissions."),j(!1),console.error("Camera error:",t)}},v=()=>{o&&(o.getTracks().forEach(t=>t.stop()),y(null)),j(!1),u(null)},S=()=>{const t=()=>{if(!c.current||!p.current||!d)return;const a=c.current,s=p.current,r=s.getContext("2d");if(!r||a.readyState!==a.HAVE_ENOUGH_DATA){requestAnimationFrame(t);return}s.width=a.videoWidth,s.height=a.videoHeight,r.drawImage(a,0,0,s.width,s.height),r.getImageData(0,0,s.width,s.height),Q(),d&&requestAnimationFrame(t)};t()},Q=t=>{Math.random()>.98&&!m&&k("https://harmonihse360.app/report/qr/loc_building_a_floor_2")},k=t=>{u(t);try{const s=new URL(t).pathname.split("/"),r=s[s.length-1];r&&r.startsWith("loc_")?(b("QR Code detected! Redirecting to incident report..."),v(),setTimeout(()=>{x(`/incidents/quick-report?qr=${r}&location=${w(r)}`)},1500)):(i("Invalid QR code. Please scan a valid incident reporting QR code."),u(null))}catch{i("Unable to read QR code data. Please try again."),u(null)}},w=t=>t.replace("loc_","").split("_").map(s=>s.charAt(0).toUpperCase()+s.slice(1)).join(" "),D=()=>{x("/incidents/quick-report")};return e.jsxs(q,{className:"justify-content-center",children:[e.jsx(F,{xs:12,md:8,lg:6,children:e.jsxs(P,{children:[e.jsxs(H,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"mb-0",children:"QR Code Scanner"}),e.jsx("small",{className:"text-muted",children:"Scan location QR codes for quick reporting"})]}),e.jsx(h,{color:"light",variant:"ghost",onClick:()=>x("/incidents"),children:e.jsx(l,{icon:A})})]}),e.jsxs(U,{children:[g&&e.jsxs(N,{color:"danger",dismissible:!0,onClose:()=>i(null),children:[e.jsx("strong",{children:"Error!"})," ",g]}),f&&e.jsxs(N,{color:"success",children:[e.jsx("strong",{children:"Success!"})," ",f]}),e.jsx("div",{className:"text-center mb-4",children:d?e.jsxs("div",{className:"position-relative",children:[e.jsx("video",{ref:c,className:"w-100 rounded",style:{maxHeight:"400px",objectFit:"cover"},muted:!0,playsInline:!0}),e.jsx("canvas",{ref:p,style:{display:"none"}}),e.jsx("div",{className:"position-absolute top-50 start-50 translate-middle",children:e.jsx("div",{className:"border border-primary border-3 rounded",style:{width:"200px",height:"200px",background:"rgba(255,255,255,0.1)",animation:"pulse 2s infinite"},children:e.jsx("div",{className:"d-flex align-items-center justify-content-center h-100",children:e.jsx(l,{icon:C,size:"2x",className:"text-primary"})})})}),m&&e.jsx("div",{className:"position-absolute bottom-0 start-0 end-0 p-3",children:e.jsxs(T,{color:"success",className:"px-3 py-2",children:[e.jsx(l,{icon:E,className:"me-2"}),"QR Code Detected!"]})})]}):e.jsxs("div",{className:"py-5",children:[e.jsx(l,{icon:C,size:"4x",className:"text-muted mb-3"}),e.jsx("h5",{children:"Ready to Scan"}),e.jsx("p",{className:"text-muted",children:"Position your camera over a QR code to automatically start incident reporting for that location."})]})}),e.jsx("div",{className:"d-grid gap-2",children:d?e.jsx(h,{color:"danger",variant:"outline",onClick:v,disabled:!!m,children:m?e.jsxs(e.Fragment,{children:[e.jsx(z,{size:"sm",className:"me-2"}),"Processing..."]}):"Stop Camera"}):e.jsxs(e.Fragment,{children:[e.jsxs(h,{color:"primary",size:"lg",onClick:R,children:[e.jsx(l,{icon:_,className:"me-2"}),"Start Camera"]}),e.jsx(h,{color:"secondary",variant:"outline",onClick:D,children:"Report Without QR Code"})]})}),e.jsx("div",{className:"mt-4 text-center",children:e.jsxs("small",{className:"text-muted",children:[e.jsx("strong",{children:"How to use:"}),e.jsx("br",{}),`1. Click "Start Camera" to activate your device's camera`,e.jsx("br",{}),"2. Point your camera at a QR code posted at incident locations",e.jsx("br",{}),"3. The app will automatically detect the code and pre-fill location details",e.jsx("br",{}),"4. Complete your incident report with location information already filled in"]})})]})]})}),e.jsx("style",{children:`
        @keyframes pulse {
          0% { opacity: 0.6; }
          50% { opacity: 1; }
          100% { opacity: 0.6; }
        }
      `})]})};export{$ as default};
