import{j as e,a0 as E,a1 as S,a2 as P}from"./index-CEPkdG4-.js";import{u as q,i as M,r as p}from"./react-vendor-CTgry22P.js";import{I as j}from"./Icon-B4fkNQKE.js";import{x as C,y as g,A as L,B as Q,r as N,D as B,v as T,K as O,F as z,Z as l,I as x,_ as U,Q as W,b as y,u as Y}from"./coreui-vendor-BHlqdV6q.js";import"./redux-vendor-CopoOshl.js";const K=()=>{const w=q(),[u]=M(),[t,d]=p.useState({title:"",description:"",severity:"Minor",location:"",incidentDate:new Date().toISOString().slice(0,16),reporterName:"",reporterEmail:"",isAnonymous:!1,photos:[]}),[v,b]=p.useState(!1),[m,h]=p.useState(null),[f,F]=p.useState(!1);p.useEffect(()=>{const s=u.get("qr"),r=u.get("location"),a=u.get("lat"),o=u.get("lng");s&&d(i=>({...i,qrCodeId:s,location:r||i.location,latitude:a?parseFloat(a):void 0,longitude:o?parseFloat(o):void 0})),navigator.geolocation&&f&&navigator.geolocation.getCurrentPosition(i=>{d(c=>({...c,latitude:i.coords.latitude,longitude:i.coords.longitude}))},i=>{console.warn("Location access denied:",i)})},[u,f]);const n=(s,r)=>{d(a=>({...a,[s]:r}))},A=async s=>{const r=s.target.files;if(!r)return;const a=[];for(let o=0;o<Math.min(r.length,5);o++){const i=r[o];if(i.type.startsWith("image/"))try{const c=await I(i);a.push(c)}catch(c){console.error("Error converting photo:",c)}}d(o=>({...o,photos:[...o.photos,...a].slice(0,5)}))},I=s=>new Promise((r,a)=>{const o=new FileReader;o.readAsDataURL(s),o.onload=()=>{const c=o.result.split(",")[1];r(c)},o.onerror=a}),k=s=>{d(r=>({...r,photos:r.photos.filter((a,o)=>o!==s)}))},D=async s=>{s.preventDefault(),b(!0),h(null);try{const r={title:t.title,description:t.description,severity:t.severity,location:t.location,incidentDate:new Date(t.incidentDate).toISOString(),reporterName:t.isAnonymous?"Anonymous Reporter":t.reporterName,reporterEmail:t.isAnonymous?"":t.reporterEmail,isAnonymous:t.isAnonymous,qrCodeId:t.qrCodeId,latitude:t.latitude,longitude:t.longitude,reportingChannel:t.qrCodeId?"QR":"QuickWeb",deviceInfo:navigator.userAgent,photoBase64:t.photos},a=t.isAnonymous?"/api/multichannel-reporting/anonymous":"/api/multichannel-reporting/quick-report",o=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(o.ok){const i=await o.json();h({type:"success",message:i.message||"Report submitted successfully!",referenceNumber:i.referenceNumber}),d({title:"",description:"",severity:"Minor",location:t.location,incidentDate:new Date().toISOString().slice(0,16),reporterName:"",reporterEmail:"",isAnonymous:!1,photos:[]})}else{const i=await o.json();h({type:"error",message:i.message||"Failed to submit report. Please try again."})}}catch{h({type:"error",message:"Network error. Please check your connection and try again."})}finally{b(!1)}},R=s=>{switch(s){case"Critical":return"danger";case"Serious":return"warning";case"Moderate":return"info";default:return"success"}};return e.jsx(C,{className:"justify-content-center",children:e.jsx(g,{xs:12,md:8,lg:6,children:e.jsxs(L,{children:[e.jsxs(Q,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"mb-0",children:"Quick Incident Report"}),e.jsx("small",{className:"text-muted",children:"Fast and easy incident reporting"})]}),t.qrCodeId&&e.jsxs(N,{color:"info",children:[e.jsx(j,{icon:E,className:"me-1"}),"QR Code Location"]})]}),e.jsxs(B,{children:[m&&e.jsxs(T,{color:m.type==="success"?"success":"danger",dismissible:!0,onClose:()=>h(null),children:[e.jsx("strong",{children:m.type==="success"?"Success!":"Error!"})," ",m.message,m.referenceNumber&&e.jsxs("div",{className:"mt-2",children:[e.jsx("strong",{children:"Reference Number:"})," ",m.referenceNumber]})]}),t.qrCodeId&&e.jsxs(O,{color:"info",className:"mb-4",children:[e.jsx("strong",{children:"Location detected from QR code"}),e.jsx("br",{}),"This form has been pre-filled with location information from the QR code you scanned."]}),e.jsxs(z,{onSubmit:D,children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"form-check form-switch",children:[e.jsx("input",{className:"form-check-input",type:"checkbox",id:"anonymousToggle",checked:t.isAnonymous,onChange:s=>n("isAnonymous",s.target.checked)}),e.jsx("label",{className:"form-check-label",htmlFor:"anonymousToggle",children:"Submit as anonymous report"})]}),e.jsx("small",{className:"text-muted",children:"Anonymous reports are investigated but you won't receive status updates"})]}),!t.isAnonymous&&e.jsxs(C,{className:"mb-3",children:[e.jsxs(g,{md:6,children:[e.jsx(l,{htmlFor:"reporterName",children:"Your Name *"}),e.jsx(x,{type:"text",id:"reporterName",value:t.reporterName,onChange:s=>n("reporterName",s.target.value),required:!t.isAnonymous,placeholder:"Enter your full name"})]}),e.jsxs(g,{md:6,children:[e.jsx(l,{htmlFor:"reporterEmail",children:"Your Email *"}),e.jsx(x,{type:"email",id:"reporterEmail",value:t.reporterEmail,onChange:s=>n("reporterEmail",s.target.value),required:!t.isAnonymous,placeholder:"your.email@example.com"})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx(l,{htmlFor:"title",children:"Incident Title *"}),e.jsx(x,{type:"text",id:"title",value:t.title,onChange:s=>n("title",s.target.value),required:!0,placeholder:"Brief description of what happened"})]}),e.jsxs("div",{className:"mb-3",children:[e.jsx(l,{htmlFor:"description",children:"Description *"}),e.jsx(U,{id:"description",rows:4,value:t.description,onChange:s=>n("description",s.target.value),required:!0,placeholder:"Provide detailed information about the incident..."})]}),e.jsxs(C,{className:"mb-3",children:[e.jsxs(g,{md:6,children:[e.jsx(l,{htmlFor:"severity",children:"Severity"}),e.jsxs(W,{id:"severity",value:t.severity,onChange:s=>n("severity",s.target.value),children:[e.jsx("option",{value:"Minor",children:"Minor"}),e.jsx("option",{value:"Moderate",children:"Moderate"}),e.jsx("option",{value:"Serious",children:"Serious"}),e.jsx("option",{value:"Critical",children:"Critical"})]}),e.jsx(N,{color:R(t.severity),className:"mt-1",children:t.severity})]}),e.jsxs(g,{md:6,children:[e.jsx(l,{htmlFor:"incidentDate",children:"When did this occur?"}),e.jsx(x,{type:"datetime-local",id:"incidentDate",value:t.incidentDate,onChange:s=>n("incidentDate",s.target.value)})]})]}),e.jsxs("div",{className:"mb-3",children:[e.jsxs(l,{htmlFor:"location",children:["Location *",t.latitude&&t.longitude&&e.jsxs(N,{color:"success",className:"ms-2",children:[e.jsx(j,{icon:S,className:"me-1"}),"GPS Coordinates"]})]}),e.jsx(x,{type:"text",id:"location",value:t.location,onChange:s=>n("location",s.target.value),required:!0,placeholder:"Building, room, or area where incident occurred"}),!t.latitude&&e.jsx("div",{className:"mt-2",children:e.jsxs(y,{color:"secondary",variant:"outline",size:"sm",onClick:()=>F(!0),disabled:f,children:[e.jsx(j,{icon:S,className:"me-1"}),"Use My Location"]})})]}),e.jsxs("div",{className:"mb-3",children:[e.jsxs(l,{htmlFor:"photos",children:["Photos (",t.photos.length,"/5)",e.jsx("small",{className:"text-muted ms-2",children:"Optional - Add visual evidence"})]}),t.photos.length<5&&e.jsx("div",{className:"mb-2",children:e.jsx("input",{type:"file",id:"photos",accept:"image/*",multiple:!0,capture:"environment",onChange:A,className:"form-control"})}),t.photos.length>0&&e.jsx("div",{className:"d-flex flex-wrap gap-2",children:t.photos.map((s,r)=>e.jsxs("div",{className:"position-relative",children:[e.jsx("img",{src:`data:image/jpeg;base64,${s}`,alt:`Incident photo ${r+1}`,style:{width:"80px",height:"80px",objectFit:"cover"},className:"rounded border"}),e.jsx(y,{color:"danger",size:"sm",className:"position-absolute top-0 end-0 rounded-circle",style:{width:"24px",height:"24px",fontSize:"12px"},onClick:()=>k(r),children:"Ã—"})]},r))})]}),e.jsxs("div",{className:"d-grid gap-2",children:[e.jsx(y,{color:"primary",type:"submit",disabled:v,size:"lg",children:v?e.jsxs(e.Fragment,{children:[e.jsx(Y,{size:"sm",className:"me-2"}),"Submitting Report..."]}):e.jsxs(e.Fragment,{children:[e.jsx(j,{icon:P,className:"me-2"}),"Submit Report"]})}),e.jsx(y,{color:"secondary",variant:"outline",onClick:()=>w("/incidents"),disabled:v,children:"Cancel"})]})]})]})]})})})};export{K as default};
