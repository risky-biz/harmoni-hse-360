import{W as M,m as P,X as R,j as e,F as d,Y as o,A as p}from"./index-CEPkdG4-.js";import{r as j}from"./react-vendor-CTgry22P.js";import{B as G}from"./redux-vendor-CopoOshl.js";import{I as g}from"./Icon-B4fkNQKE.js";import{a as O}from"./dateUtils-BKWPuADf.js";import{A as _,B as W,D as V,v as Y,G as q,I as H,b as m,r as Q,u as b,a3 as X,a4 as J}from"./coreui-vendor-BHlqdV6q.js";const le=({incidentId:h,allowUpload:v=!0,allowDelete:F=!0})=>{const u=j.useRef(null),[r,x]=j.useState([]),[y,i]=j.useState(null),N=G(s=>s.auth.token),{data:f=[],isLoading:A,refetch:w}=M(h),[z,{isLoading:c}]=P(),[I,{isLoading:k}]=R(),D=s=>{const t=Array.from(s.target.files||[]),l=[];t.forEach(a=>{const B=["image/","video/","application/pdf","application/msword","text/plain"].some($=>a.type.startsWith($))||a.name.toLowerCase().endsWith(".docx"),T=50*1024*1024;if(!B){i(`File "${a.name}" is not a supported type. Please upload images, videos, PDFs, or documents.`);return}if(a.size>T){i(`File "${a.name}" is too large. Maximum size is 50MB.`);return}l.push(a)}),l.length>0&&(x(a=>[...a,...l]),i(null)),u.current&&(u.current.value="")},L=s=>{x(t=>t.filter((l,a)=>a!==s))},S=async()=>{if(r.length!==0)try{await z({incidentId:h,files:r}).unwrap(),x([]),i(null),w()}catch(s){i("Failed to upload files. Please try again."),console.error("Upload error:",s)}},U=async s=>{if(confirm("Are you sure you want to delete this attachment?"))try{await I({incidentId:h,attachmentId:s}).unwrap(),w()}catch(t){console.error("Delete error:",t)}},E=async s=>{try{if(!N){i("Authentication required. Please log in again.");return}const t=await fetch(s.fileUrl,{method:"GET",headers:{Authorization:`Bearer ${N}`}});if(!t.ok)throw new Error(`Failed to download file: ${t.status} ${t.statusText}`);const l=await t.blob(),a=window.URL.createObjectURL(l),n=document.createElement("a");n.href=a,n.download=s.fileName,n.target="_blank",document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(a)}catch(t){console.error("Download failed:",t),i(`Failed to download ${s.fileName}. Please try again.`)}},C=s=>{var l;switch((l=s.split(".").pop())==null?void 0:l.toLowerCase()){case"pdf":return o.pdf;case"doc":case"docx":return o.document;case"txt":return o.text;default:return s.match(/\.(jpg|jpeg|png|gif)$/i)?o.image:s.match(/\.(mp4|avi|mov)$/i)?o.video:o.default}};return e.jsxs(_,{className:"mb-4",children:[e.jsx(W,{children:e.jsxs("h6",{className:"mb-0",children:[e.jsx(d,{icon:o.default,className:"me-2"}),"Attachments (",f.length,")"]})}),e.jsxs(V,{children:[y&&e.jsx(Y,{color:"danger",dismissible:!0,onClose:()=>i(null),children:y}),v&&e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"mb-3",children:[e.jsxs(q,{children:[e.jsx(H,{type:"file",ref:u,onChange:D,multiple:!0,accept:"image/*,video/*,.pdf,.doc,.docx,.txt",disabled:c}),e.jsxs(m,{color:"outline-primary",onClick:()=>{var s;return(s=u.current)==null?void 0:s.click()},disabled:c,children:[e.jsx(d,{icon:p.upload,className:"me-2"}),"Select Files"]})]}),e.jsx("small",{className:"text-muted",children:"Supported: Images, Videos, PDFs, Documents (Max 50MB each)"})]}),r.length>0&&e.jsxs("div",{className:"mb-3",children:[e.jsx("div",{className:"d-flex flex-wrap gap-2 mb-3",children:r.map((s,t)=>e.jsxs(Q,{color:"light",className:"d-flex align-items-center gap-2 p-2",children:[e.jsx(g,{icon:C(s.name),size:"sm"}),e.jsx("span",{children:s.name}),e.jsx(m,{size:"sm",color:"light",variant:"ghost",onClick:()=>L(t),disabled:c,children:"×"})]},t))}),e.jsx(m,{color:"primary",onClick:S,disabled:c,size:"sm",children:c?e.jsxs(e.Fragment,{children:[e.jsx(b,{size:"sm",className:"me-2"}),"Uploading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(g,{icon:p.upload,className:"me-2"}),"Upload Files (",r.length,")"]})})]})]}),A?e.jsxs("div",{className:"text-center py-3",children:[e.jsx(b,{size:"sm",className:"me-2"}),"Loading attachments..."]}):f.length===0?e.jsxs("div",{className:"text-center text-muted py-3",children:[e.jsx(d,{icon:o.default,size:"2x",className:"mb-2 opacity-50"}),e.jsx("p",{className:"mb-0",children:"No attachments uploaded yet"})]}):e.jsx(X,{flush:!0,children:f.map(s=>e.jsxs(J,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{className:"d-flex align-items-center",children:[e.jsx(g,{icon:C(s.fileName),className:"me-3 text-muted"}),e.jsxs("div",{children:[e.jsx("div",{className:"fw-medium",children:s.fileName}),e.jsxs("small",{className:"text-muted",children:[s.fileSizeFormatted," • Uploaded by ",s.uploadedBy," • ",O(s.uploadedAt)]})]})]}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(m,{size:"sm",color:"outline-primary",onClick:()=>E(s),title:"Download",children:e.jsx(d,{icon:p.download,size:"sm"})}),F&&e.jsx(m,{size:"sm",color:"outline-danger",onClick:()=>U(s.id),disabled:k,title:"Delete",children:e.jsx(d,{icon:p.delete,size:"sm"})})]})]},s.id))})]})]})};export{le as A};
