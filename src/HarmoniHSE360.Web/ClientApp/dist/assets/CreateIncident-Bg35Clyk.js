import{k as ae,m as ne,j as e,F as re,n as oe}from"./index-CEPkdG4-.js";import{u as le,r as h}from"./react-vendor-CTgry22P.js";import{u as ce}from"./index.esm-Drw8RU7c.js";import{c as D,o as de,a as me,b as m,d as O}from"./index.esm-DQwPWBid.js";import{x as y,y as o,A as ue,B as he,w as l,r as G,u as C,b as v,D as xe,F as ve,v as pe,K as je,L as ge,M as S,N,O as I,Z as c,I as w,Q as L,_ as V,G as T,H as R}from"./coreui-vendor-BHlqdV6q.js";import{c as ye,a as U,b as fe}from"./cil-warning-Bi3wrRN_.js";import"./redux-vendor-CopoOshl.js";var Z=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M334.627,16H48V496H472V153.373ZM440,166.627V168H320V48h1.373ZM80,464V48H288V200H440V464Z' class='ci-primary'/>"],be=["512 512","<path fill='var(--ci-primary-color, currentColor)' d='M425.706,142.294A240,240,0,0,0,16,312v88H160V368H48V312c0-114.691,93.309-208,208-208s208,93.309,208,208v56H352v32H496V312A238.432,238.432,0,0,0,425.706,142.294Z' class='ci-primary'/><rect width='32' height='32' x='80' y='264' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='240' y='128' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='136' y='168' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><rect width='32' height='32' x='400' y='264' fill='var(--ci-primary-color, currentColor)' class='ci-primary'/><path fill='var(--ci-primary-color, currentColor)' d='M297.222,335.1l69.2-144.173-28.85-13.848L268.389,321.214A64.141,64.141,0,1,0,297.222,335.1ZM256,416a32,32,0,1,1,32-32A32.036,32.036,0,0,1,256,416Z' class='ci-primary'/>"];const Ce=me({title:m().required("Incident title is required").min(5,"Title must be at least 5 characters").max(100,"Title must not exceed 100 characters"),description:m().required("Description is required").min(10,"Description must be at least 10 characters").max(1e3,"Description must not exceed 1000 characters"),severity:m().required("Severity level is required").oneOf(["Minor","Moderate","Serious","Critical"],"Please select a valid severity level"),incidentDate:m().required("Incident date and time is required"),location:m().required("Location is required").min(3,"Location must be at least 3 characters"),category:m().required("Incident category is required"),latitude:O().optional(),longitude:O().optional(),involvedPersons:m().optional().max(500,"Involved persons description must not exceed 500 characters"),immediateActions:m().optional().max(500,"Immediate actions must not exceed 500 characters")}),Me=()=>{var _;const F=le(),[$,{isLoading:A}]=ae(),[K,{isLoading:q}]=ne(),[B,p]=h.useState(null),[u,j]=h.useState(null),[k,f]=h.useState(!1),[M,b]=h.useState("dropdown"),[g,E]=h.useState([]),{register:r,handleSubmit:W,formState:{errors:s,isDirty:z},watch:J,setValue:d,getValues:H}=ce({resolver:de(Ce),defaultValues:{title:"",description:"",severity:"Minor",incidentDate:new Date().toISOString().slice(0,16),location:"",category:"",involvedPersons:"",immediateActions:""}});h.useEffect(()=>{if(!z)return;const i=setInterval(()=>{const t=H();j("saving"),setTimeout(()=>{try{localStorage.setItem("incident_draft",JSON.stringify(t)),j("saved"),setTimeout(()=>j(null),2e3)}catch{j("error"),setTimeout(()=>j(null),3e3)}},500)},3e4);return()=>clearInterval(i)},[z,H]),h.useEffect(()=>{const i=localStorage.getItem("incident_draft");if(i)try{const t=JSON.parse(i);Object.keys(t).forEach(n=>{d(n,t[n])})}catch(t){console.warn("Failed to load draft:",t)}},[d]);const Q=()=>{f(!0),b("text"),navigator.geolocation?navigator.geolocation.getCurrentPosition(i=>{d("latitude",i.coords.latitude),d("longitude",i.coords.longitude),d("location",`${i.coords.latitude.toFixed(6)}, ${i.coords.longitude.toFixed(6)}`),f(!1)},i=>{console.error("Geolocation error:",i),f(!1),b("dropdown"),alert("Unable to get your location. Please enter the location manually.")}):(f(!1),b("dropdown"),alert("Geolocation is not supported by this browser."))},X=i=>{const t=Array.from(i.target.files||[]),n=t.filter(a=>{const x=a.type.startsWith("image/"),P=a.type.startsWith("video/"),te=a.size<=50*1024*1024;return(x||P)&&te});n.length!==t.length&&alert("Some files were skipped. Only images and videos under 50MB are allowed."),E(a=>[...a,...n])},Y=i=>{E(t=>t.filter((n,a)=>a!==i))},ee=async i=>{var t,n;p(null);try{const a={title:i.title,description:i.description,severity:i.severity,incidentDate:new Date(i.incidentDate).toISOString(),location:i.location,latitude:i.latitude,longitude:i.longitude,witnessNames:i.involvedPersons||void 0,immediateActionsTaken:i.immediateActions||void 0},x=await $(a).unwrap();if(g.length>0)try{await K({incidentId:x.id,files:g}).unwrap(),console.log(`Successfully uploaded ${g.length} files for incident ${x.id}`)}catch(P){console.error("Failed to upload files:",P)}localStorage.removeItem("incident_draft"),F("/incidents",{state:{message:"Incident reported successfully!",type:"success"}})}catch(a){if((t=a.data)!=null&&t.message)p(a.data.message);else if((n=a.data)!=null&&n.errors){const x=Object.values(a.data.errors).flat().join(", ");p(x)}else p("Failed to submit incident report. Please try again.");console.error("Submit error:",a)}},ie=[{value:"student_injury",label:"Student Injury (Sports, Playground, Classroom)"},{value:"staff_injury",label:"Staff/Teacher Injury"},{value:"visitor_incident",label:"Visitor Incident"},{value:"property_damage",label:"Property Damage"},{value:"environmental",label:"Environmental Incident"},{value:"security",label:"Security Incident"},{value:"near_miss",label:"Near-Miss Event"},{value:"medical_emergency",label:"Medical Emergency"},{value:"lab_accident",label:"Laboratory Accident"},{value:"transportation",label:"Transportation Incident"}],se=["Main Building - Ground Floor","Main Building - 1st Floor","Main Building - 2nd Floor","Science Wing - Chemistry Lab","Science Wing - Physics Lab","Science Wing - Biology Lab","Library - Main Hall","Library - Study Rooms","Gymnasium - Main Court","Gymnasium - Equipment Room","Cafeteria - Dining Area","Cafeteria - Kitchen","Playground - Primary","Playground - Secondary","Swimming Pool Area","Parking Area","Sports Field","Other (specify in description)"];return e.jsx(y,{children:e.jsx(o,{xs:12,children:e.jsxs(ue,{className:"shadow-sm",children:[e.jsxs(he,{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsxs("h4",{className:"mb-0",style:{color:"var(--harmoni-charcoal)",fontFamily:"Poppins, sans-serif"},children:[e.jsx(l,{icon:ye,size:"lg",className:"me-2 text-warning"}),"Report New Incident"]}),e.jsx("small",{className:"text-muted",children:"Fill out all required information to report an incident"})]}),e.jsxs("div",{className:"d-flex align-items-center gap-2",children:[u&&e.jsxs(G,{color:u==="saved"?"success":u==="saving"?"info":"danger",className:"d-flex align-items-center",children:[u==="saving"&&e.jsx(C,{size:"sm",className:"me-1"}),e.jsx(l,{icon:u==="saved"?U:D,size:"sm",className:"me-1"}),u==="saved"?"Auto-saved":u==="saving"?"Saving...":"Save failed"]}),e.jsxs(v,{color:"secondary",variant:"outline",onClick:()=>F("/incidents"),children:[e.jsx(l,{icon:be,size:"sm",className:"me-1"}),"Back to List"]})]})]}),e.jsx(xe,{children:e.jsxs(ve,{onSubmit:W(ee),children:[B&&e.jsx(pe,{color:"danger",dismissible:!0,onClose:()=>p(null),children:B}),e.jsxs(je,{color:"info",className:"mb-4",children:[e.jsx(l,{icon:D,className:"me-2"}),e.jsx("strong",{children:"Important:"})," Report incidents as soon as possible. All serious incidents must be reported within 2 hours according to Indonesian regulations."]}),e.jsxs(ge,{children:[e.jsxs(S,{itemKey:1,children:[e.jsx(N,{children:e.jsx("strong",{children:"1. Basic Information"})}),e.jsxs(I,{children:[e.jsxs(y,{className:"mb-3",children:[e.jsxs(o,{md:6,children:[e.jsx(c,{htmlFor:"title",children:"Incident Title *"}),e.jsx(w,{id:"title",...r("title"),invalid:!!s.title,placeholder:"Brief description of what happened"}),s.title&&e.jsx("div",{className:"invalid-feedback d-block",children:s.title.message})]}),e.jsxs(o,{md:3,children:[e.jsx(c,{htmlFor:"severity",children:"Severity Level *"}),e.jsxs(L,{id:"severity",...r("severity"),invalid:!!s.severity,children:[e.jsx("option",{value:"Minor",children:"Minor"}),e.jsx("option",{value:"Moderate",children:"Moderate"}),e.jsx("option",{value:"Serious",children:"Serious"}),e.jsx("option",{value:"Critical",children:"Critical"})]}),s.severity&&e.jsx("div",{className:"invalid-feedback d-block",children:s.severity.message})]}),e.jsxs(o,{md:3,children:[e.jsx(c,{htmlFor:"category",children:"Category *"}),e.jsxs(L,{id:"category",...r("category"),invalid:!!s.category,children:[e.jsx("option",{value:"",children:"Select category..."}),ie.map(i=>e.jsx("option",{value:i.value,children:i.label},i.value))]}),s.category&&e.jsx("div",{className:"invalid-feedback d-block",children:s.category.message})]})]}),e.jsx(y,{className:"mb-3",children:e.jsxs(o,{xs:12,children:[e.jsx(c,{htmlFor:"description",children:"Detailed Description *"}),e.jsx(V,{id:"description",rows:4,...r("description"),invalid:!!s.description,placeholder:"Describe what happened in detail. Include any relevant circumstances, conditions, or factors that may have contributed to the incident."}),s.description&&e.jsx("div",{className:"invalid-feedback d-block",children:s.description.message}),e.jsxs("small",{className:"text-muted",children:[((_=J("description"))==null?void 0:_.length)||0,"/1000 characters"]})]})})]})]}),e.jsxs(S,{itemKey:2,children:[e.jsx(N,{children:e.jsx("strong",{children:"2. Location and Time"})}),e.jsx(I,{children:e.jsxs(y,{className:"mb-3",children:[e.jsxs(o,{md:6,children:[e.jsx(c,{htmlFor:"incidentDate",children:"Incident Date and Time *"}),e.jsxs(T,{children:[e.jsx(R,{children:e.jsx(l,{icon:fe})}),e.jsx(w,{id:"incidentDate",type:"datetime-local",...r("incidentDate"),invalid:!!s.incidentDate})]}),s.incidentDate&&e.jsx("div",{className:"invalid-feedback d-block",children:s.incidentDate.message})]}),e.jsxs(o,{md:6,children:[e.jsx(c,{htmlFor:"location",children:"Location *"}),e.jsxs(T,{children:[M==="dropdown"?e.jsxs(L,{id:"location",...r("location"),invalid:!!s.location,children:[e.jsx("option",{value:"",children:"Select location..."}),se.map(i=>e.jsx("option",{value:i,children:i},i))]}):e.jsx(w,{id:"location",...r("location"),invalid:!!s.location,placeholder:"Enter coordinates or location details",readOnly:k}),e.jsx(v,{type:"button",color:"primary",variant:"outline",onClick:Q,disabled:k,children:k?e.jsx(C,{size:"sm"}):e.jsx(re,{icon:oe})}),M==="text"&&e.jsx(v,{type:"button",color:"secondary",variant:"outline",onClick:()=>{b("dropdown"),d("location",""),d("latitude",void 0),d("longitude",void 0)},title:"Switch back to dropdown",children:"↩"})]}),s.location&&e.jsx("div",{className:"invalid-feedback d-block",children:s.location.message}),e.jsx("small",{className:"text-muted",children:M==="dropdown"?"Click the location button to use GPS coordinates":"GPS coordinates will be stored in the database. Click ↩ to use dropdown again."})]})]})})]}),e.jsxs(S,{itemKey:3,children:[e.jsx(N,{children:e.jsx("strong",{children:"3. Additional Details"})}),e.jsx(I,{children:e.jsxs(y,{className:"mb-3",children:[e.jsxs(o,{md:6,children:[e.jsx(c,{htmlFor:"involvedPersons",children:"Involved Persons"}),e.jsx(V,{id:"involvedPersons",rows:3,...r("involvedPersons"),invalid:!!s.involvedPersons,placeholder:"List any persons involved (witnesses, injured parties, etc.)"}),s.involvedPersons&&e.jsx("div",{className:"invalid-feedback d-block",children:s.involvedPersons.message})]}),e.jsxs(o,{md:6,children:[e.jsx(c,{htmlFor:"immediateActions",children:"Immediate Actions Taken"}),e.jsx(V,{id:"immediateActions",rows:3,...r("immediateActions"),invalid:!!s.immediateActions,placeholder:"Describe any immediate actions taken to address the incident"}),s.immediateActions&&e.jsx("div",{className:"invalid-feedback d-block",children:s.immediateActions.message})]})]})})]}),e.jsxs(S,{itemKey:4,children:[e.jsx(N,{children:e.jsx("strong",{children:"4. Evidence (Photos/Videos)"})}),e.jsxs(I,{children:[e.jsxs("div",{className:"mb-3",children:[e.jsx(c,{htmlFor:"files",children:"Upload Photos or Videos"}),e.jsxs(T,{children:[e.jsx(w,{id:"files",type:"file",multiple:!0,accept:"image/*,video/*",onChange:X}),e.jsx(R,{children:e.jsx(l,{icon:Z})})]}),e.jsx("small",{className:"text-muted",children:"Maximum 5 photos, 2-minute videos. Files must be under 50MB each."})]}),g.length>0&&e.jsxs("div",{children:[e.jsx("h6",{children:"Uploaded Files:"}),g.map((i,t)=>e.jsxs(G,{color:"success",className:"me-2 mb-2 d-inline-flex align-items-center",children:[e.jsx(l,{icon:Z,size:"sm",className:"me-1"}),i.name,e.jsx(v,{size:"sm",color:"light",className:"ms-2 p-0",style:{width:"16px",height:"16px"},onClick:()=>Y(t),children:"×"})]},t))]})]})]})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center mt-4 pt-3 border-top",children:[e.jsx("div",{className:"text-muted",children:e.jsxs("small",{children:[e.jsx(l,{icon:D,size:"sm",className:"me-1"}),"Form auto-saves every 30 seconds"]})}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(v,{type:"button",color:"secondary",variant:"outline",onClick:()=>F("/incidents"),disabled:A,children:"Cancel"}),e.jsx(v,{type:"submit",color:"primary",disabled:A||q,className:"d-flex align-items-center",children:A?e.jsxs(e.Fragment,{children:[e.jsx(C,{size:"sm",className:"me-2"}),"Submitting..."]}):q?e.jsxs(e.Fragment,{children:[e.jsx(C,{size:"sm",className:"me-2"}),"Uploading files..."]}):e.jsxs(e.Fragment,{children:[e.jsx(l,{icon:U,size:"sm",className:"me-2"}),"Submit Report"]})})]})]})]})})]})})})};export{Me as default};
